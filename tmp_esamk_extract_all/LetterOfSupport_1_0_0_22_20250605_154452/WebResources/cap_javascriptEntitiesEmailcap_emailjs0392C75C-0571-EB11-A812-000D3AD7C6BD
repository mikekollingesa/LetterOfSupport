var CG = CG || {};
CG = window.CG || {};
CG.Esa = CG.Esa || {};
CG.Esa.Email = CG.Esa.Email || {};
CG.Esa.Email.Form = {
    onLoad: function (executionContext) {
        var formContext = executionContext.getFormContext();
        var regarding = formContext.getAttribute("regardingobjectid").getValue();
        var fromlookup = new Array();

        if (regarding !== null) {
            var regardingid = regarding[0].id;

            // Handle 'cap_getintouch' entity type
            if (formContext.ui.getFormType() === 2 && regarding[0].entityType === "cap_getintouch") {
                Xrm.WebApi.online.retrieveRecord("cap_getintouch", regardingid, "?$select=_ownerid_value").then(
                    function success(result) {
                        var _owner_name = result["_ownerid_value@OData.Community.Display.V1.FormattedValue"];

                        if (_owner_name === "DG - Get in Touch Management") {
                            // Retrieve and set 'from' and 'ownerid' for 'DG - Get in Touch Management'
                            Xrm.WebApi.online.retrieveMultipleRecords("queue", "?$select=name,emailaddress,queueid&$filter=emailaddress eq 'commercialisation.gateway@esa.int'").then(
                                function success(results) {
                                    fromlookup[0] = {
                                        id: results.entities[0]["queueid"],
                                        name: results.entities[0]["name"],
                                        entityType: "queue"
                                    };
                                    formContext.getAttribute("from").setValue(fromlookup);
                                },
                                function (error) {
                                    Xrm.Utility.alertDialog(error.message);
                                }
                            );

                            Xrm.WebApi.online.retrieveMultipleRecords("team", "?$select=teamid,name&$filter=name eq 'DG - Get in Touch Management'").then(
                                function success(results) {
                                    fromlookup[0] = {
                                        id: results.entities[0]["teamid"],
                                        name: results.entities[0]["name"],
                                        entityType: "team"
                                    };
                                    formContext.getAttribute("ownerid").setValue(fromlookup);
                                },
                                function (error) {
                                    Xrm.Utility.alertDialog(error.message);
                                }
                            );
                        } else if (_owner_name === "OPS - Get in Touch Management") {
                            // Retrieve and set 'from' and 'ownerid' for 'OPS - Get in Touch Management'
                            Xrm.WebApi.online.retrieveMultipleRecords("queue", "?$select=name,emailaddress,queueid&$filter=emailaddress eq 'ops@esa.int'").then(
                                function success(results) {
                                    fromlookup[0] = {
                                        id: results.entities[0]["queueid"],
                                        name: results.entities[0]["name"],
                                        entityType: "queue"
                                    };
                                    formContext.getAttribute("from").setValue(fromlookup);
                                },
                                function (error) {
                                    Xrm.Utility.alertDialog(error.message);
                                }
                            );

                            Xrm.WebApi.online.retrieveMultipleRecords("team", "?$select=teamid,name&$filter=name eq 'OPS - Get in Touch Management'").then(
                                function success(results) {
                                    fromlookup[0] = {
                                        id: results.entities[0]["teamid"],
                                        name: results.entities[0]["name"],
                                        entityType: "team"
                                    };
                                    formContext.getAttribute("ownerid").setValue(fromlookup);
                                },
                                function (error) {
                                    Xrm.Utility.alertDialog(error.message);
                                }
                            );
                        }
                    },
                    function (error) {
                        Xrm.Utility.alertDialog(error.message);
                    }
                );
            }

            // Handle 'dxc_civilsocietygateway' entity type
            else if (formContext.ui.getFormType() === 2 && regarding[0].entityType === "dxc_civilsocietygateway") {
                Xrm.WebApi.online.retrieveRecord("dxc_civilsocietygateway", regardingid, "?$select=_ownerid_value").then(
                    function success(result) {
                        var _owner_name = result["_ownerid_value@OData.Community.Display.V1.FormattedValue"];

                        if (_owner_name === "DG-Civil Society Gateway Team") {
                            // Retrieve and set 'from' and 'ownerid' for 'DG-Civil Society Gateway Team'
                            Xrm.WebApi.online.retrieveMultipleRecords("queue", "?$select=name,emailaddress,queueid&$filter=emailaddress eq 'cso@esa.int'").then(
                                function success(results) {
                                    fromlookup[0] = {
                                        id: results.entities[0]["queueid"],
                                        name: results.entities[0]["name"],
                                        entityType: "queue"
                                    };
                                    formContext.getAttribute("from").setValue(fromlookup);
                                },
                                function (error) {
                                    Xrm.Utility.alertDialog(error.message);
                                }
                            );

                            Xrm.WebApi.online.retrieveMultipleRecords("team", "?$select=teamid,name&$filter=name eq 'DG-Civil Society Gateway Team'").then(
                                function success(results) {
                                    fromlookup[0] = {
                                        id: results.entities[0]["teamid"],
                                        name: results.entities[0]["name"],
                                        entityType: "team"
                                    };
                                    formContext.getAttribute("ownerid").setValue(fromlookup);
                                },
                                function (error) {
                                    Xrm.Utility.alertDialog(error.message);
                                }
                            );
                        }
                    },
                    function (error) {
                        Xrm.Utility.alertDialog(error.message);
                    }
                );
            }
        }
    }
}
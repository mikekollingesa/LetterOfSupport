function sendtospecifier(primaryControl) {
    console.log("🟢 Function 'updateAndNotify' triggered");

    try {
        if (!primaryControl) {
            console.error("❌ No primaryControl passed to function");
            alert("Primary Control not available. Please check Ribbon setup.");
            return;
        }

        const entityId = primaryControl.data?.entity?.getId()?.replace(/[{}]/g, "");
        const entityName = primaryControl.data?.entity?.getEntityName();

        console.log("📄 Entity Name:", entityName);
        console.log("🆔 Entity ID:", entityId);

        if (!entityId || !entityName) {
            throw new Error("Could not retrieve entity info. Ensure the record is saved.");
        }

        const updateData = {
            esamk_submit: "SendToSpecifier"
        };

        console.log("📦 Update Payload:", updateData);

        // Optional placeholder — actual button disabling is done via Enable Rule
        disableRibbonButton(primaryControl);

        // Update the record via Web API
        console.log("🚀 Attempting to update record...");
        Xrm.WebApi.updateRecord(entityName, entityId, updateData).then(
            function success(result) {
                console.log("✅ Record updated successfully:", result);
                showToast("Submit In Progress", 2); // Success
                setTimeout(() => {
                    console.log("🔄 Refreshing form...");
                    primaryControl.data.refresh();
                }, 1000);
            },
            function (error) {
                console.error("❌ Web API error:", error.message);
                showToast("Error: " + error.message, 4); // Error
            }
        );
    } catch (error) {
        console.error("❗ Try/Catch Error:", error.message);
        showToast("Error: " + error.message, 4);
    }
}

// 🔔 Show toast-style notification
function showToast(message, type) {
    console.log("🔔 Showing toast notification:", message);
    Xrm.App.addGlobalNotification({
        type: type, // 1 = Info, 2 = Success, 3 = Warning, 4 = Error
        level: 200000,
        message: message,
        showCloseButton: true
    }).then(function (id) {
        setTimeout(() => {
            Xrm.App.clearGlobalNotification(id);
        }, 4000);
    });
}

// 🔒 Placeholder for Ribbon disabling — use Enable Rule instead
function disableRibbonButton(primaryControl) {
    console.log("ℹ️ Ribbon button can be disabled via Enable Rules, not JavaScript.");
}

// ✅ Enable Rule Function — Disable button if already submitted
function isNotSubmittedToSpecifier(primaryControl) {
    try {
        console.log("🟠 Enable Rule: isNotSubmittedToSpecifier triggered");

        if (!primaryControl) {
            console.warn("⚠️ primaryControl not provided");
            return true;
        }

        var attr = primaryControl.getAttribute("esamk_submit");
        if (!attr) {
            console.log("ℹ️ Field 'esamk_submit' not found on form. Assuming not submitted.");
            return true;
        }

        var value = attr.getValue();
        console.log("📝 esamk_submit value:", value);

        return value !== "SendToSpecifier" && value !== "Sent" && value !== "SentToSpecifier";
    } catch (e) {
        console.error("❗ Enable Rule Error:", e.message);
        return true;
    }
}




function isNotDelegate(primaryControl) {
    try {
        console.log("✅ isNotDelegate rule called");

        if (!primaryControl) {
            console.warn("⚠️ primaryControl is missing");
            return true; // Enable by default
        }

        var field = primaryControl.getAttribute("esamk_jsusertype");
        if (!field) {
            console.warn("⚠️ Field 'esamk_jsusertype' not found on form");
            return true; // Enable by default
        }

        var value = field.getValue();
        console.log("👤 esamk_jsusertype value:", value);

        return value !== 305290001;
    } catch (e) {
        console.error("❗ Enable Rule Error:", e.message);
        return true; // Fail-safe: keep button enabled
    }
}



// ✅ Combined Enable Rule Function — Disable button if submitted OR user is a delegate
function isButtonEnabled(primaryControl) {
    try {
        console.log("🔄 Combined Enable Rule: isButtonEnabled triggered");

        if (!primaryControl) {
            console.warn("⚠️ primaryControl not provided");
            return false; // Disable by default
        }

        // Check esamk_submit field
        var submitAttr = primaryControl.getAttribute("esamk_submit");
        var submitValue = submitAttr ? submitAttr.getValue() : null;

        if (!submitAttr) {
            console.log("ℹ️ Field 'esamk_submit' not found. Assuming not submitted.");
        }
        console.log("📝 esamk_submit value:", submitValue);

        var isSubmitted =
            submitValue === "SendToSpecifier" ||
            submitValue === "Sent" ||
            submitValue === "SentToSpecifier";

        // Check esamk_jsusertype field
        var userTypeAttr = primaryControl.getAttribute("esamk_jsusertype");
        var userTypeValue = userTypeAttr ? userTypeAttr.getValue() : null;

        if (!userTypeAttr) {
            console.warn("⚠️ Field 'esamk_jsusertype' not found. Assuming not a delegate.");
        }
        console.log("👤 esamk_jsusertype value:", userTypeValue);

        var isDelegate = userTypeValue === 305290001;

        // Disable the button if either condition is true
        return !(isSubmitted || isDelegate);
    } catch (e) {
        console.error("❗ Combined Enable Rule Error:", e.message);
        return false; // Fail-safe: disable button
    }
}




function isButtonEnabled2(primaryControl) {
    try {
        console.log("🟠 Enable Rule: isButtonEnabled triggered");

        if (!primaryControl) return false;

        const submitAttr = primaryControl.getAttribute("esamk_submit");
        const submitValue = submitAttr ? submitAttr.getValue() : null;
        console.log("📝 esamk_submit value:", submitValue);

        const userAttr = primaryControl.getAttribute("esamk_jsusertype");
        const userValue = userAttr ? userAttr.getValue() : null;
        console.log("👤 esamk_jsusertype value:", userValue);

        const isSubmitted = ["Sent", "SendToSpecifier", "SentToSpecifier"].includes(submitValue);
        const isDelegate = userValue === 305290001;

        const enabled = !(isSubmitted || isDelegate);
        console.log(`✅ Button enabled: ${enabled}`);
        return enabled;

    } catch (e) {
        console.error("❗ Enable Rule Error:", e);
        return false; // disable on error
    }
}


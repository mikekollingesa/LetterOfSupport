// This creates a safe space for our code to run
var ESAMK = window.ESAMK || {};
(function () {
    // The function now accepts a parameter called 'executionContext'
    this.openSpecifierPicker = function (executionContext) {
        // *** THIS IS THE FIX ***
        // We get the form's context from the executionContext
        var formContext = executionContext.getFormContext();

        // --- The rest of the code is the same and will now work correctly ---

        // 1. Get the ID of the current record
        var projectId = formContext.data.entity.getId();
        if (!projectId) {
            Xrm.Navigation.openAlertDialog({ text: "Please save the record before adding specifiers." });
            return;
        }

        // 2. Get the value of the "Member State" lookup field
        var countryLookup = formContext.getAttribute("esamk_memberstate").getValue();
        if (!countryLookup || countryLookup.length === 0) {
            Xrm.Navigation.openAlertDialog({ text: "Please select a Member State first." });
            return;
        }
        var countryId = countryLookup[0].id;

        // 3. Define the custom page we want to open
        var pageInput = {
            pageType: "custom",
            // *** MAKE SURE YOUR UNIQUE PAGE NAME IS PASTED HERE ***
            name: "Canvas1",
            data: {
                projectid: projectId.replace(/[{}]/g, ""),
                countryid: countryId.replace(/[{}]/g, "")
            }
        };

        // 4. Define how we want the page to open
        var navigationOptions = {
            target: 2,
            position: 1,
            width: { value: 50, unit: "%" },
            title: "Add Specifiers by Country"
        };

        // 5. Open the page
        Xrm.Navigation.navigateTo(pageInput, navigationOptions).then(
            function success() {
                var subgrid = formContext.getControl("SpecifiersSubgrid"); // <-- Change this if your subgrid has a different name
                if (subgrid) {
                    subgrid.refresh();
                }
            }
        );
    }
}).call(ESAMK);